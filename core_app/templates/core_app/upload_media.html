{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Media | Missing Persons Finder{% endblock %}

{% block additional_styles %}
<!-- Video.js CSS -->
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />

<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;700&family=Poppins:wght@300;400;500&family=Montserrat:wght@700&display=swap');
    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css");
    
    body {
        background: linear-gradient(to bottom, #623B81, #AC63A0);
        font-family: 'Poppins', sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    /* Top Navigation Bar */
    .top-nav {
        background-color: #FFF8F0;
        padding: 1rem 2rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .logo-section {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .app-name {
        color: #623B81;
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 1.8rem;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(172, 99, 160, 0.3);
    }

    .nav-links {
        display: flex;
        gap: 1.5rem;
    }

    .nav-link {
        color: #623B81;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        transition: all 0.3s ease;
    }

    .nav-link.active {
        background: linear-gradient(45deg, #623B81, #AC63A0);
        color: white;
    }

    .nav-link:hover:not(.active) {
        background: rgba(172, 99, 160, 0.1);
    }

    /* Main Content */
    .main-content {
        margin-top: 100px;
        padding: 2rem;
    }

    .upload-media-container {
        margin-top: 30px;
        padding: 25px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        color: #623B81;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .profile-dropdown {
        max-width: 300px;
        background-color: rgba(98, 59, 129, 0.6);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 50px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .profile-dropdown:focus {
        background-color: rgba(98, 59, 129, 0.8);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        outline: none;
    }

    .profile-select-container {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
    }

    .upload-section {
        margin-bottom: 30px;
    }

    .upload-label {
        font-weight: 600;
        margin-bottom: 15px;
        display: block;
        color: #333;
    }

    .upload-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .upload-btn {
        width: 150px;
        height: 150px;
        border: 2px dashed #AC63A0;
        background: none;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-btn:hover {
        background: rgba(172, 99, 160, 0.1);
        transform: translateY(-2px);
    }

    .upload-btn i {
        font-size: 2rem;
        color: #623B81;
        margin-bottom: 0.5rem;
    }

    .upload-btn span {
        font-size: 0.8rem;
        color: #623B81;
        display: block;
        text-align: center;
    }

    .media-thumbnail {
        width: 150px;
        height: 150px;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .media-thumbnail img, 
    .media-thumbnail video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .media-actions {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }

    .media-action-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .media-action-btn:hover {
        background: white;
        transform: translateY(-2px);
    }

    .media-action-btn i {
        font-size: 0.9rem;
        color: #623B81;
    }

    .live-source-btn {
        display: none;
    }

    .live-sources-container {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .hidden {
        display: none !important;
    }

    .media-preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .media-preview-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .media-preview-content {
        max-width: 80%;
        max-height: 80%;
    }

    .media-preview-content img {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 10px;
    }

    .media-preview-content video {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 10px;
    }

    .media-preview-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .media-preview-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
    }

    .profile-select-container {
        text-align: center;
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
    }

    .profile-select-btn {
        display: none;
    }

    .user-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
    }

    .username {
        color: #623B81;
        font-weight: 500;
    }

    .profile-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #623B81, #AC63A0);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .profile-icon:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(172, 99, 160, 0.4);
    }

    .profile-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: #FFF8F0;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        min-width: 200px;
        display: none;
    }

    .profile-menu.show {
        display: block;
    }

    .profile-menu a {
        display: block;
        padding: 0.75rem 1rem;
        color: #623B81;
        text-decoration: none;
        transition: all 0.3s ease;
        border-radius: 5px;
    }

    .profile-menu a:hover {
        background: rgba(172, 99, 160, 0.1);
    }

    .direct-profile-select {
        display: none;
    }

    .direct-profile-item {
        display: none;
    }

    .profile-selection-message {
        margin-bottom: 1.5rem;
        display: block;
    }

    .profile-selection-message.hidden {
        display: none;
    }

    /* Adjustments for live action buttons if needed */
    .live-action-btn {
        flex-direction: column;
        justify-content: center;
    }

    .webcam-select-container {
        margin-top: 1rem;
        padding: 1rem;
        background-color: rgba(255, 248, 240, 0.9);
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .webcam-select-container label {
        color: #623B81;
        font-weight: 500;
    }

    /* Webcam Controls Styling */
    .webcam-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50px;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 2001;
    }
    
    .webcam-buttons {
        display: flex;
        gap: 15px;
    }
    
    .webcam-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #623B81;
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .webcam-btn:hover {
        background: #AC63A0;
        transform: scale(1.1);
    }
    
    .webcam-btn i {
        font-size: 1.5rem;
    }
    
    .webcam-settings {
        display: none !important;
    }
    
    .setting-group {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .setting-group label {
        color: #333;
        font-weight: 500;
    }
    
    .setting-group select {
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    .settings-btn {
        padding: 8px 15px;
        background: #623B81;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
    }
    
    .settings-btn:hover {
        background: #AC63A0;
    }
    
    .recording-timer {
        position: absolute;
        top: -30px;
        background: rgba(255, 0, 0, 0.7);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
    }
    
    #stop-recording-btn {
        background-color: #d9534f;
    }
    
    #stop-recording-btn:hover {
        background-color: #c9302c;
    }

    /* Modal styling for webcam selection */
    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    
    .modal-content {
        background-color: white;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }
    
    .modal-header {
        background-color: #623B81;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h4 {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    
    .form-buttons {
        display: flex;
        justify-content: flex-end;
    }
    
    .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .primary-btn {
        background-color: #623B81;
        color: white;
    }
    
    .primary-btn:hover {
        background-color: #AC63A0;
    }
    
    .hidden {
        display: none !important;
    }

    /* Upload progress styles */
    .upload-progress-container {
        margin-top: 15px;
        margin-bottom: 20px;
        max-width: 500px;
    }
    
    .progress {
        height: 20px;
        border-radius: 10px;
        background-color: #f0f0f0;
        margin-bottom: 5px;
        overflow: hidden;
    }
    
    .progress-bar {
        background-color: #4285f4;
        color: white;
        text-align: center;
        line-height: 20px;
        font-size: 12px;
        transition: width 0.3s ease;
    }
    
    .progress-bar.bg-danger {
        background-color: #dc3545;
    }

    @keyframes pulseAnimation {
        0% { 
            transform: scale(1); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); 
        }
        50% { 
            transform: scale(1.02); /* Reduced scale for subtlety */
            box-shadow: 0 7px 20px rgba(98, 59, 129, 0.35); /* Reduced shadow intensity */
        }
        100% { 
            transform: scale(1); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); 
        }
    }

    .main-start-search-btn-styled {
        background-color: #623B81;
        border: none;
        font-size: 1.2rem;
        padding: 12px 30px;
        border-radius: 50px;
        position: relative;
        z-index: 10;
        cursor: pointer;
        display: inline-block;
        text-decoration: none;
        color: white !important; /* Ensure text color is white */
        animation: pulseAnimation 3s infinite ease-in-out; /* Slower, smoother animation */
        transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    }

    .main-start-search-btn-styled:hover {
        transform: scale(1.05); /* Slightly larger pop on hover */
        box-shadow: 0 8px 25px rgba(98, 59, 129, 0.5);
        animation-play-state: paused; /* Pause pulsing on hover */
        background-color: #623B81 !important; /* Prevent Bootstrap's blue hover */
        color: white !important; /* Ensure text stays white */
    }
</style>
{% endblock %}

{% block content %}
<!-- Top Navigation Bar -->
<nav class="top-nav">
    <div class="logo-section">
        <h1 class="app-name">Finder</h1>
        <div class="nav-links">
            <a href="{% url 'core_app:dashboard' %}" class="nav-link">Dashboard</a>
            <a href="{% url 'core_app:upload_media' %}" class="nav-link active">Upload Media</a>
            <a href="#" class="nav-link">Live Search</a>
        </div>
    </div>
    <div class="user-section">
        <span class="username">{{ user.username }}</span>
        <div class="profile-icon" onclick="toggleProfileMenu()">
            <i class="bi bi-person-fill"></i>
        </div>
        <div class="profile-menu" id="profileMenu">
            <a href="#"><i class="bi bi-gear-fill"></i> Settings</a>
            <a href="#"><i class="bi bi-shield-lock-fill"></i> Change Password</a>
            <a href="{% url 'user_auth:logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a>
        </div>
    </div>
</nav>

<div class="main-content">
    {% csrf_token %}
    {% if not missing_persons_data %}
    <div class="alert alert-warning">
        <strong>No profiles found!</strong> You need to create a missing person profile before you can upload media. <a href="{% url 'core_app:dashboard' %}" class="alert-link">Go to Dashboard</a> to create a profile first.
    </div>
    {% endif %}
    
    <!-- Select Profile Section -->
    <div class="profile-select-container">
        <select class="form-select profile-dropdown" id="profile-selector">
            <option value="" selected disabled>Choose profile</option>
            {% for item in missing_persons_data %}
                <option value="{{ item.person.id }}" data-name="{{ item.person.full_name }}">{{ item.person.full_name }} ({{ item.person.age }})</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- Upload Media Container -->
    <div class="upload-media-container" id="upload-media-container">
        <!-- Profile Selection Message -->
        <div class="profile-selection-message" id="profile-selection-message">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Please select a missing person profile above before uploading media.
            </div>
        </div>
        
        <!-- Images Upload Section -->
        <div class="upload-section">
            <label class="upload-label">Upload missing persons images:</label>
            <div class="upload-grid" id="images-grid">
                <!-- Add Image Button -->
                <label class="upload-btn" for="image-upload">
                    <i class="bi bi-plus-lg"></i>
                    <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
                </label>
                <!-- Images will be added here dynamically -->
            </div>
            
            <!-- Progress container for image uploads -->
            <div class="upload-progress-container" id="image-upload-progress-container" style="display: none;">
                <div class="progress">
                    <div id="image-upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="image-upload-status" class="mt-2 small text-muted"></div>
            </div>
        </div>

        <!-- Videos Upload Section -->
        <div class="upload-section">
            <label class="upload-label">Upload recorded footage:</label>
            <div class="upload-grid" id="videos-grid">
                <!-- Add Video Button -->
                <label class="upload-btn" for="video-upload">
                    <i class="bi bi-plus-lg"></i>
                    <input type="file" id="video-upload" class="hidden" accept="video/*" multiple>
                </label>
                <!-- Videos will be added here dynamically -->
            </div>
            
            <!-- Progress container for video uploads -->
            <div class="upload-progress-container" id="video-upload-progress-container" style="display: none;">
                <div class="progress">
                    <div id="video-upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="video-upload-status" class="mt-2 small text-muted"></div>
            </div>
        </div>

        <!-- Live Footage Section -->
        <div class="upload-section">
            <label class="upload-label">Link live footage:</label>
            
            <!-- Live Sources Grid (Now includes add buttons) -->
            <div class="upload-grid" id="live-sources-grid">
                <!-- Add Webcam Button -->
                <button type="button" class="upload-btn live-action-btn" id="webcam-select-btn">
                    <i class="bi bi-camera-video"></i>
                    <span>Web Cam</span>
                </button>
                
                <!-- Live source thumbnails will be added here dynamically -->
            </div>
            
            <!-- Webcam Selection Container - Initially Hidden -->
            <div id="webcam-select-container" class="modal-container hidden">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4>Select Camera</h4>
                        <button id="cancel-webcam-select-btn" class="close-btn"><i class="bi bi-x"></i></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="webcam-device-select">Available Cameras:</label>
                            <select id="webcam-device-select" class="form-control">
                                <option value="">Loading cameras...</option>
                            </select>
                        </div>
                        <div class="form-buttons">
                            <button id="start-webcam-preview-btn" class="action-btn primary-btn">Start Preview</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Prominent Start Search Button - Added at the bottom -->
        <div class="text-center mt-4 mb-3">
            <a href="#" id="main-start-search-btn" class="btn btn-primary btn-lg main-start-search-btn-styled"
               onclick="handleStartSearchClick(); return false;">
                <i class="bi bi-search"></i> Start Face Recognition Search
            </a>
        </div>
    </div>
</div>

<!-- Media Preview Overlay -->
<div class="media-preview-overlay" id="media-preview-overlay">
    <div class="media-preview-close" id="preview-close-btn">
        <i class="bi bi-x"></i>
    </div>
    <div class="media-preview-content" id="media-preview-content">
        <!-- Preview content will be inserted here -->
    </div>
    
    <!-- Webcam Controls Container - Initially Hidden -->
    <div class="webcam-controls" id="webcam-controls" style="display: none;">
        <div class="webcam-buttons">
            <button id="take-snapshot-btn" class="webcam-btn" title="Take Photo">
                <i class="bi bi-camera"></i>
            </button>
            <button id="start-recording-btn" class="webcam-btn" title="Start Recording">
                <i class="bi bi-record-circle"></i>
            </button>
            <button id="stop-recording-btn" class="webcam-btn" style="display: none;" title="Stop Recording">
                <i class="bi bi-stop-circle"></i>
            </button>
        </div>
        <div class="recording-timer" id="recording-timer" style="display: none;">00:00</div>
    </div>
</div>

<!-- Replace webcam active indicator with background preview thumbnail -->
<div id="background-webcam-container" class="hidden" style="display:none">
    <!-- This will be cloned and inserted into the live sources grid -->
    <div class="media-thumbnail webcam-background-thumbnail">
        <video id="background-webcam" autoplay muted playsinline></video>
        <div class="media-actions">
            <button class="media-action-btn" id="webcam-expand-btn">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <button class="media-action-btn" id="webcam-stop-btn">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
        <div class="webcam-indicator">
            <i class="bi bi-record-circle" style="color: red;"></i> Live
        </div>
    </div>
</div>

<!-- Video.js JavaScript -->
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<!-- Video.js DASH Plugin -->
<script src="https://cdn.jsdelivr.net/npm/videojs-contrib-dash@5.1.1/dist/videojs-dash.min.js"></script>

<script>
    // Function to toggle the profile menu dropdown
    function toggleProfileMenu() {
        const profileMenu = document.getElementById('profileMenu');
        profileMenu.classList.toggle('show');
    }
    
    // Define these variables globally so they're accessible to the handleStartSearchClick function
    let isWebcamActive = false;
    let activeWebcamSourceId = null;
    let currentDeviceId = null;
    
    // Handle search button click (global function for inline onclick)
    function handleStartSearchClick() {
        console.log("Start search button clicked via inline handler");
        
        // Get the profile selector
        const profileSelector = document.getElementById('profile-selector');
        if (profileSelector && profileSelector.value) {
            const personId = profileSelector.value;
            console.log(`Navigating to live search with person ID: ${personId}`);
            
            let redirectUrl = `/live-search-redirect/?person_id=${personId}`;
            if (isWebcamActive && activeWebcamSourceId) {
                console.log(`Appending active webcam source ID: ${activeWebcamSourceId}`);
                redirectUrl += `&source_id=${activeWebcamSourceId}`;
                
                // Also pass the device ID if available
                if (currentDeviceId) {
                    console.log(`Appending webcam device ID: ${currentDeviceId}`);
                    redirectUrl += `&device_id=${currentDeviceId}`;
                }
            }
            
            console.log(`Redirecting to: ${redirectUrl}`);
            window.location.href = redirectUrl;

        } else {
            alert('Please select a missing person profile first');
        }
    }
    
    // Close the profile menu when clicking outside of it
    document.addEventListener('click', function(event) {
        const profileMenu = document.getElementById('profileMenu');
        const profileIcon = document.querySelector('.profile-icon');
        
        if (profileMenu.classList.contains('show') && 
            !profileMenu.contains(event.target) && 
            !profileIcon.contains(event.target)) {
            profileMenu.classList.remove('show');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Document loaded");
        
        // Flag to indicate event listeners are initialized
        window.searchButtonInitialized = true;
        
        // DOM Elements
        const profileSelector = document.getElementById('profile-selector');
        const uploadMediaContainer = document.getElementById('upload-media-container');
        const profileSelectionMessage = document.getElementById('profile-selection-message');
        const imagesGrid = document.getElementById('images-grid');
        const videosGrid = document.getElementById('videos-grid');
        const liveSourcesGrid = document.getElementById('live-sources-grid');
        const imageUploadInput = document.getElementById('image-upload');
        const videoUploadInput = document.getElementById('video-upload');
        const webcamSelectBtn = document.getElementById('webcam-select-btn');
        const mainStartSearchBtn = document.getElementById('main-start-search-btn');
        const previewOverlay = document.getElementById('media-preview-overlay');
        const previewContent = document.getElementById('media-preview-content');
        const previewCloseBtn = document.getElementById('preview-close-btn');
        const webcamSelectContainer = document.getElementById('webcam-select-container');
        const webcamDeviceSelect = document.getElementById('webcam-device-select');
        const startWebcamPreviewBtn = document.getElementById('start-webcam-preview-btn');
        const cancelWebcamSelectBtn = document.getElementById('cancel-webcam-select-btn');
        const webcamControls = document.getElementById('webcam-controls');
        const takeSnapshotBtn = document.getElementById('take-snapshot-btn');
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopRecordingBtn = document.getElementById('stop-recording-btn');
        const recordingTimer = document.getElementById('recording-timer');
        const webcamExpandBtn = document.getElementById('webcam-expand-btn');
        const webcamStopBtn = document.getElementById('webcam-stop-btn');
        
        // State
        let selectedPersonId = null;
        let selectedPersonName = null;
        let currentWebcamStream = null; // Keep track of the active stream
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = 0;
        let recordingTimerId = null;
        let backgroundVideoElement = null;
        
        // Event Listeners for Profile Selection
        if (profileSelector) {
            profileSelector.addEventListener('change', function() {
                selectedPersonId = this.value;
                console.log("Profile selected, ID:", selectedPersonId);
                
                if (selectedPersonId) { // Only proceed if a valid profile ID is selected
                    // Get the selected option
                    const selectedOption = this.options[this.selectedIndex];
                    selectedPersonName = selectedOption.getAttribute('data-name');
                    console.log("Selected Name:", selectedPersonName);
                    
                    // Hide the profile selection message
                    if (profileSelectionMessage) {
                        console.log("Hiding profile selection message");
                        profileSelectionMessage.classList.add('hidden');
                    } else {
                        console.error("Profile selection message element not found");
                    }
                    
                    // Load existing media
                    loadExistingMedia(selectedPersonId);
                } else {
                    // If the user selects the default "Choose profile" option
                    console.log("Default profile option selected, showing message");
                    if (profileSelectionMessage) {
                        profileSelectionMessage.classList.remove('hidden');
                    }
                    // Clear media grids if no profile is selected
                    imagesGrid.innerHTML = '';
                    videosGrid.innerHTML = '';
                    liveSourcesGrid.innerHTML = '';
                }
            });
        } else {
            console.error("Profile selector element not found");
        }
        
        // Constants for chunked uploads
        const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB chunks
        const LARGE_FILE_THRESHOLD = 5 * 1024 * 1024; // 5MB threshold for chunked upload

        // Function to upload a file in chunks with progress indicator
        function uploadFileInChunks(file, fileType) {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first');
                return;
            }
            
            // Show progress container based on file type
            const progressContainer = fileType === 'image' 
                ? document.getElementById('image-upload-progress-container')
                : document.getElementById('video-upload-progress-container');
            
            const progressBar = fileType === 'image'
                ? document.getElementById('image-upload-progress-bar')
                : document.getElementById('video-upload-progress-bar');
            
            const statusElement = fileType === 'image'
                ? document.getElementById('image-upload-status')
                : document.getElementById('video-upload-status');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusElement.textContent = `Preparing to upload ${file.name}...`;
            
            // Generate a unique file ID
            const fileId = Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9);
            
            // Calculate total chunks
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            let currentChunk = 0;
            let totalProgress = 0;
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Function to upload a single chunk
            function uploadChunk() {
                // Calculate chunk boundaries
                const start = currentChunk * CHUNK_SIZE;
                const end = Math.min(file.size, start + CHUNK_SIZE);
                const chunk = file.slice(start, end);
                
                // Create form data for this chunk
                const formData = new FormData();
                formData.append('chunk', chunk, file.name);
                formData.append('chunk_number', currentChunk);
                formData.append('total_chunks', totalChunks);
                formData.append('file_type', fileType);
                formData.append('file_id', fileId);
                
                // Update status
                statusElement.textContent = `Uploading chunk ${currentChunk + 1} of ${totalChunks}...`;
                
                // Send the chunk
                fetch(`/api/missing-persons/${selectedPersonId}/chunk/upload/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Upload failed');
                    }
                    
                    // Update progress
                    currentChunk++;
                    totalProgress = Math.min(100, Math.round((currentChunk / totalChunks) * 100));
                    progressBar.style.width = `${totalProgress}%`;
                    progressBar.textContent = `${totalProgress}%`;
                    
                    // If this was the last chunk
                    if (currentChunk >= totalChunks) {
                        statusElement.textContent = `Upload of ${file.name} complete!`;
                        
                        // If this was the last chunk, server has combined all chunks and returned the final file details
                        if (fileType === 'image' && data.image_id) {
                            // Create and append the thumbnail for the image
                            const element = createThumbnailElement(data.url, data.image_id, 'image', data.title || file.name);
                            document.getElementById('images-grid').appendChild(element);
                        } else if (fileType === 'video' && data.video_id) {
                            // Create and append the thumbnail for the video
                            const element = createThumbnailElement(data.url, data.video_id, 'video', data.title || file.name);
                            document.getElementById('videos-grid').appendChild(element);
                        }
                        
                        // Hide progress after 2 seconds
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 2000);
                    } else {
                        // Upload next chunk
                        uploadChunk();
                    }
                })
                .catch(error => {
                    console.error('Chunk upload failed:', error);
                    statusElement.textContent = `Error: ${error.message}`;
                    progressBar.classList.add('bg-danger');
                });
            }
            
            // Start uploading chunks
            uploadChunk();
        }

        // Override the existing image upload handler
        imageUploadInput.addEventListener('change', function(e) {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first');
                return;
            }
            
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Use chunked upload for large files
                if (file.size > LARGE_FILE_THRESHOLD) {
                    uploadFileInChunks(file, 'image');
                } else {
                    // Use regular upload for smaller files
                    uploadImage(file);
                }
            }
            // Reset input
            this.value = '';
        });
        
        // Override the existing video upload handler
        videoUploadInput.addEventListener('change', function(e) {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first');
                return;
            }
            
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Always use chunked upload for videos as they're typically large
                uploadFileInChunks(file, 'video');
            }
            // Reset input
            this.value = '';
        });
        
        // Webcam Source
        webcamSelectBtn.addEventListener('click', function() {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first');
                return;
            }
            console.log("Webcam select button clicked - populating devices");
            populateWebcamDevices();
            webcamSelectContainer.classList.remove('hidden');
        });
        
        // Cancel Webcam Selection
        cancelWebcamSelectBtn.addEventListener('click', function() {
            webcamSelectContainer.classList.add('hidden');
        });
        
        // Start Webcam Preview Button Click
        startWebcamPreviewBtn.addEventListener('click', function() {
            const selectedDeviceId = webcamDeviceSelect.value;
            if (!selectedDeviceId) {
                alert("Please select a webcam device.");
                return;
            }
            console.log(`Starting preview for device ID: ${selectedDeviceId}`);
            webcamSelectContainer.classList.add('hidden'); // Hide selector
            startLocalWebcamPreview(selectedDeviceId);
        });
        
        // Preview Close
        previewCloseBtn.addEventListener('click', function() {
            if (currentWebcamStream) {
                // Instead of stopping the stream, keep it active in the background
                keepWebcamActive();
            } else {
                // For non-webcam previews (like video.js player)
                const player = videojs.getPlayer('live-preview-player');
                if (player) {
                    player.dispose();
                    console.log("Video.js player disposed");
                }
            }
            
            // Always hide the preview overlay
            previewOverlay.classList.remove('active');
            previewContent.innerHTML = '';
        });
        
        // Event listeners for webcam controls
        takeSnapshotBtn.addEventListener('click', takeSnapshot);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);

        // Functions
        async function populateWebcamDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.error("enumerateDevices() not supported.");
                webcamDeviceSelect.innerHTML = '<option value="">Cannot list devices</option>';
                return;
            }

            // First request camera permission to get device labels
            try {
                // Request temporary access to any camera to get permission
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                
                // Now we can enumerate devices with labels
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                // Stop the temporary stream immediately
                tempStream.getTracks().forEach(track => track.stop());
                
                // Process device list
                webcamDeviceSelect.innerHTML = ''; // Clear existing options
                let count = 0;
                
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${count + 1}`;
                        webcamDeviceSelect.appendChild(option);
                        count++;
                    }
                });
                
                if (count === 0) {
                    webcamDeviceSelect.innerHTML = '<option value="">No cameras found</option>';
                }
            } catch (err) {
                console.error('Error accessing camera:', err);
                
                if (err.name === 'NotAllowedError') {
                    webcamDeviceSelect.innerHTML = '<option value="">Camera access denied</option>';
                } else if (err.name === 'NotFoundError') {
                    webcamDeviceSelect.innerHTML = '<option value="">No camera detected</option>';
                } else {
                    webcamDeviceSelect.innerHTML = `<option value="">Error: ${err.message}</option>`;
                }
            }
        }
        
        async function startLocalWebcamPreview(deviceId) {
            console.log(`Attempting to access webcam with deviceId: ${deviceId || 'default'}`);
            previewContent.innerHTML = '';
            previewOverlay.classList.add('active');
            
            // Simple function to stop any existing stream
            if (currentWebcamStream) {
                currentWebcamStream.getTracks().forEach(track => track.stop());
                currentWebcamStream = null;
            }
            
            // Basic constraints
            const constraints = {
                video: deviceId ? { deviceId: { exact: deviceId } } : true,
                audio: false
            };
            
            // Save the device ID globally so it can be passed to the search page
            currentDeviceId = deviceId;
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    // Store stream for later use
                    currentWebcamStream = stream;
                    isWebcamActive = true;
                    
                    // Create video element
                    const video = document.createElement('video');
                    video.id = 'local-webcam-preview';
                    video.srcObject = stream;
                    video.autoplay = true;
                    video.playsInline = true;
                    video.style.maxWidth = '100%';
                    video.style.maxHeight = '80vh';
                    video.style.transform = 'scaleX(-1)';
                    previewContent.appendChild(video);
                    
                    // Create backend entry
                    createWebcamBackendEntry();
                    
                    // Also create grid thumbnail with the same stream
                    createWebcamThumbnailInGrid();
                    
                    // Show webcam controls
                    webcamControls.style.display = 'flex';
                })
                .catch(err => {
                    console.error('Error accessing webcam:', err);
                    let errorMsg = 'Could not access webcam.';
                    
                    if (err.name === 'NotAllowedError') {
                        errorMsg = 'Camera permission denied. Please allow camera access in your browser settings.';
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = 'No camera found on your device.';
                    }
                    
                    previewContent.innerHTML = `<p style="color:red;">${errorMsg}</p>`;
                });
        }

        function createWebcamBackendEntry() {
            if (!selectedPersonId) return;
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Use XHR for more consistent handling
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `/api/missing-persons/${selectedPersonId}/webcam/add/`, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success && data.source_id) {
                            activeWebcamSourceId = data.source_id;
                            console.log('Webcam source added with ID:', activeWebcamSourceId);
                        }
                    } catch (e) {
                        console.error('Error parsing response:', e);
                    }
                }
            };
            
            xhr.send(JSON.stringify({}));
        }

        // Keep webcam active in background
        function keepWebcamActive() {
            if (!currentWebcamStream) {
                return;
            }
            
            console.log("Keeping webcam active in background");
            
            // Create an invisible video element to keep the stream active
            if (!backgroundVideoElement) {
                backgroundVideoElement = document.createElement('video');
                backgroundVideoElement.id = 'background-webcam';
                backgroundVideoElement.style.position = 'absolute';
                backgroundVideoElement.style.left = '-9999px'; // Off-screen
                backgroundVideoElement.style.top = '-9999px';
                backgroundVideoElement.autoplay = true;
                backgroundVideoElement.muted = true;
                document.body.appendChild(backgroundVideoElement);
            }
            
            // Set the current stream to the background video
            backgroundVideoElement.srcObject = currentWebcamStream;
            
            // Create a thumbnail in the grid for the active webcam
            createWebcamThumbnailInGrid();
            
            // Hide webcam controls
            webcamControls.style.display = 'none';
            
            // Hide the preview overlay
            previewOverlay.classList.remove('active');
            previewContent.innerHTML = '';
        }

        // New function to create a webcam thumbnail in the grid
        function createWebcamThumbnailInGrid() {
            // First, check if we already have a webcam thumbnail
            const existingThumbnail = document.querySelector('.media-thumbnail[data-active-webcam="true"]');
            if (existingThumbnail) {
                // Update the existing thumbnail
                const videoElement = existingThumbnail.querySelector('video');
                if (videoElement) {
                    videoElement.srcObject = currentWebcamStream;
                }
                return;
            }
            
            // Create a new thumbnail element
            const thumbnailElement = document.createElement('div');
            thumbnailElement.className = 'media-thumbnail';
            thumbnailElement.setAttribute('data-active-webcam', 'true');
            
            // Create video element for live preview
            const videoElement = document.createElement('video');
            videoElement.autoplay = true;
            videoElement.muted = true;
            videoElement.playsInline = true;
            videoElement.srcObject = currentWebcamStream;
            videoElement.style.transform = 'scaleX(-1)'; // Mirror video
            thumbnailElement.appendChild(videoElement);
            
            // Add indicator that this is a live webcam
            const webcamIndicator = document.createElement('div');
            webcamIndicator.className = 'webcam-indicator';
            webcamIndicator.innerHTML = '<i class="bi bi-record-circle" style="color: red;"></i> Live';
            webcamIndicator.style.position = 'absolute';
            webcamIndicator.style.bottom = '5px';
            webcamIndicator.style.left = '5px';
            webcamIndicator.style.background = 'rgba(0, 0, 0, 0.5)';
            webcamIndicator.style.color = 'white';
            webcamIndicator.style.padding = '3px 8px';
            webcamIndicator.style.borderRadius = '10px';
            webcamIndicator.style.fontSize = '0.7rem';
            thumbnailElement.appendChild(webcamIndicator);
            
            // Add actions (preview, stop)
            const actions = document.createElement('div');
            actions.className = 'media-actions';
            
            // Preview button
            const previewBtn = document.createElement('button');
            previewBtn.className = 'media-action-btn';
            previewBtn.innerHTML = '<i class="bi bi-eye"></i>';
            previewBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                reopenWebcamPreview();
            });
            actions.appendChild(previewBtn);
            
            // Stop webcam button
            const stopBtn = document.createElement('button');
            stopBtn.className = 'media-action-btn';
            stopBtn.innerHTML = '<i class="bi bi-x-circle"></i>';
            stopBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                stopWebcamCompletely();
                thumbnailElement.remove();
            });
            actions.appendChild(stopBtn);
            
            thumbnailElement.appendChild(actions);
            
            // Handle direct click on the thumbnail
            thumbnailElement.addEventListener('click', function() {
                reopenWebcamPreview();
            });
            
            // Add to the grid
            liveSourcesGrid.appendChild(thumbnailElement);
        }

        // Update stopWebcamCompletely to remove the grid thumbnail
        function stopWebcamCompletely() {
            if (!isWebcamActive) {
                return;
            }
            
            console.log("Completely stopping webcam");
            
            // Stop all tracks
            if (currentWebcamStream) {
                currentWebcamStream.getTracks().forEach(track => track.stop());
                
                // Stop audio stream if it exists
                if (currentWebcamStream.audioStream) {
                    currentWebcamStream.audioStream.getTracks().forEach(track => track.stop());
                }
                
                currentWebcamStream = null;
            }
            
            // Remove background video element
            if (backgroundVideoElement) {
                backgroundVideoElement.srcObject = null;
                backgroundVideoElement.remove();
                backgroundVideoElement = null;
            }
            
            // Remove the grid thumbnail
            const webcamThumbnail = document.querySelector('.media-thumbnail[data-active-webcam="true"]');
            if (webcamThumbnail) {
                webcamThumbnail.remove();
            }
            
            // Stop media recorder if active
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Clear recording timer if active
            if (recordingTimerId) {
                clearInterval(recordingTimerId);
                recordingTimerId = null;
            }
            
            // Reset state
            isWebcamActive = false;
        }

        // Reopen webcam preview from background
        function reopenWebcamPreview() {
            if (!isWebcamActive || !currentWebcamStream) {
                console.error("No active webcam to reopen");
                return;
            }
            
            console.log("Reopening webcam preview");
            previewContent.innerHTML = '';
            previewOverlay.classList.add('active'); // Show full overlay
            
            // Create a video element for the preview
            const videoElement = document.createElement('video');
            videoElement.id = 'local-webcam-preview';
            videoElement.srcObject = currentWebcamStream;
            videoElement.autoplay = true;
            videoElement.playsInline = true;
            videoElement.style.maxWidth = '100%';
            videoElement.style.maxHeight = '80vh';
            videoElement.style.transform = 'scaleX(-1)';
            previewContent.appendChild(videoElement);
            
            // Show webcam controls
            webcamControls.style.display = 'flex';
            
            // Reset recording UI if needed
            resetRecordingUI();
        }

        // Completely stop the webcam
        function stopWebcamCompletely() {
            if (!isWebcamActive) {
                return;
            }
            
            console.log("Completely stopping webcam");
            
            // Stop all tracks
            if (currentWebcamStream) {
                currentWebcamStream.getTracks().forEach(track => track.stop());
                
                // Stop audio stream if it exists
                if (currentWebcamStream.audioStream) {
                    currentWebcamStream.audioStream.getTracks().forEach(track => track.stop());
                }
                
                currentWebcamStream = null;
            }
            
            // Remove background video element
            if (backgroundVideoElement) {
                backgroundVideoElement.srcObject = null;
                backgroundVideoElement.remove();
                backgroundVideoElement = null;
            }
            
            // Remove the grid thumbnail
            const webcamThumbnail = document.querySelector('.media-thumbnail[data-active-webcam="true"]');
            if (webcamThumbnail) {
                webcamThumbnail.remove();
            }
            
            // Stop media recorder if active
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // Clear recording timer if active
            if (recordingTimerId) {
                clearInterval(recordingTimerId);
                recordingTimerId = null;
            }
            
            // Reset state
            isWebcamActive = false;
        }

        // Update loadExistingMedia to avoid adding a placeholder if the webcam is active
        function loadExistingMedia(personId) {
            if (!personId) {
                console.error("No person ID provided");
                return;
            }
            
            console.log("Loading existing media for person ID:", personId);
            
            // Clear only existing media thumbnails, preserve the add buttons
            imagesGrid.querySelectorAll('.media-thumbnail').forEach(thumb => thumb.remove());
            videosGrid.querySelectorAll('.media-thumbnail').forEach(thumb => thumb.remove());
            // Clear only backend-generated live source thumbnails, not the active one
            liveSourcesGrid.querySelectorAll('.media-thumbnail:not([data-active-webcam="true"])').forEach(thumb => thumb.remove());
            
            // Load existing images
            fetch(`/api/missing-persons/${personId}/images/`)
                .then(response => {
                    if (!response.ok) {
                        console.error(`Server returned ${response.status} when loading images`);
                        return []; // Return empty array on error
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} images`);
                    data.forEach(image => {
                        const element = createThumbnailElement(image.url, image.id, 'image', image.title);
                        imagesGrid.appendChild(element); // Append the new thumbnail
                    });
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                });
            
            // Load existing videos
            fetch(`/api/missing-persons/${personId}/videos/`)
                .then(response => {
                    if (!response.ok) {
                        console.error(`Server returned ${response.status} when loading videos`);
                        return [];
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} videos`);
                    data.forEach(video => {
                        const element = createThumbnailElement(video.url, video.id, 'video', video.title);
                        videosGrid.appendChild(element); // Append the new thumbnail
                    });
                })
                .catch(error => {
                    console.error('Error loading videos:', error);
                });
            
            // Load existing live sources
            fetch(`/api/missing-persons/${personId}/live-sources/`)
                .then(response => {
                    if (!response.ok) {
                        console.error(`Server returned ${response.status} when loading live sources`);
                        return [];
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} live sources from backend`);
                    
                    // Filter for only webcam sources
                    const webcamSources = data.filter(source => source.source_type === 'webcam');
                    console.log(`Found ${webcamSources.length} webcam sources`);

                    webcamSources.forEach(source => {
                        // Skip if a thumbnail for this source is already active and displayed
                        const existingActiveThumb = document.querySelector(`.media-thumbnail[data-source-id="${source.id}"]`);
                        if (existingActiveThumb) {
                            console.log(`Skipping already active webcam source with ID: ${source.id}`);
                            return;
                        }

                        const element = createThumbnailElement(
                            "{% static 'images/webcam-placeholder.svg' %}", 
                            source.id, 
                            'live', 
                            source.description || 'Webcam'
                        );
                        element.setAttribute('data-source-type', 'webcam');
                        element.setAttribute('data-source-id', source.id);
                        liveSourcesGrid.appendChild(element);
                    });
                })
                .catch(error => {
                    console.error('Error loading live sources:', error);
                });
        }

        // Restore the original logic for creating media elements and handling clicks
        function createThumbnailElement(src, id, type, title = 'Loading...') {
            console.log(`Creating thumbnail - Type: ${type}, ID: ${id}, Title: ${title}, Raw SRC: ${src}`); // Log input
            const div = document.createElement('div');
            div.className = 'media-thumbnail';
            div.id = `media-${type}-${id}`; // Use a more specific ID

            // Special attribute for webcam placeholders (from backend)
            if (type === 'live' && title.toLowerCase().includes('webcam')) {
                div.setAttribute('data-source-type', 'webcam');
            }
            
            let mediaElement;
            if (type === 'image') {
                mediaElement = document.createElement('img');
                mediaElement.alt = title;
                mediaElement.onerror = function() { // Add error handler
                    console.error(`Error loading image thumbnail for ID ${id}. SRC: ${this.src}`);
                    this.alt = 'Error loading image';
                    // Optionally set a placeholder source
                    // this.src = '{% static 'images/image-error-placeholder.svg' %}'; 
                };
                mediaElement.src = src; // Set src last
                console.log(`Image element created with src: ${mediaElement.src}`);
            } else if (type === 'video') {
                // For videos, use video element for better thumbnails
                mediaElement = document.createElement('video');
                mediaElement.src = src;
                mediaElement.muted = true; // Required for autoplay
                mediaElement.preload = 'metadata'; // Just load metadata for thumbnail
                
                // Try to set poster from the first frame
                mediaElement.addEventListener('loadeddata', function() {
                    try {
                        // Attempt to get the first frame as a poster image
                        if (this.videoWidth && this.videoHeight) {
                            this.currentTime = 0.1; // Seek a bit into the video
                        }
                    } catch (e) {
                        console.error('Error setting video thumbnail time:', e);
                    }
                });
            } else {
                // For live sources, use an appropriate placeholder image
                mediaElement = document.createElement('img');
                const isWebcamPlaceholder = div.getAttribute('data-source-type') === 'webcam';
                mediaElement.src = isWebcamPlaceholder 
                    ? "{% static 'images/webcam-placeholder.svg' %}"
                    : "{% static 'images/live-stream-placeholder.svg' %}";
                mediaElement.alt = title;
            }
            
            div.appendChild(mediaElement);
            
            // Add actions
            const actions = document.createElement('div');
            actions.className = 'media-actions';
            
            // Preview button
            const previewBtn = document.createElement('button');
            previewBtn.className = 'media-action-btn';
            previewBtn.innerHTML = '<i class="bi bi-eye"></i>';
            previewBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log(`Preview button clicked - Type: ${type}, ID: ${id}, SRC: ${src}`);
                const isWebcamPlaceholder = div.getAttribute('data-source-type') === 'webcam';
                if (isWebcamPlaceholder) {
                    if (isWebcamActive && currentWebcamStream) {
                        console.log("Webcam placeholder clicked with active webcam - showing webcam");
                        reopenWebcamPreview();
                    } else {
                        console.log("Webcam placeholder clicked but no active webcam");
                        showPreview(src, 'webcam-placeholder'); // Use special type
                    }
                } else {
                    // Default action for image, video, and live URL types
                    showPreview(src, type);
                }
            });
            actions.appendChild(previewBtn);
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'media-action-btn';
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log(`Delete button clicked - Type: ${type}, ID: ${id}`);
                deleteMedia(id, type, div);
            });
            actions.appendChild(deleteBtn);
            
            div.appendChild(actions);
            
            // Handle direct click on the thumbnail
            div.addEventListener('click', function() {
                console.log(`Thumbnail direct click - Type: ${type}, ID: ${id}, SRC: ${src}`);
                const isWebcamPlaceholder = div.getAttribute('data-source-type') === 'webcam';
                if (isWebcamPlaceholder) {
                    if (isWebcamActive && currentWebcamStream) {
                        console.log("Webcam placeholder direct click with active webcam - showing webcam");
                        reopenWebcamPreview();
                    } else {
                        console.log("Webcam placeholder direct click but no active webcam");
                        showPreview(src, 'webcam-placeholder'); // Use special type
                    }
                } else {
                    // Default action for image, video, and live URL types
                    showPreview(src, type);
                }
            });
            
            return div;
        }

        // COMPLETELY FIXED CORE FUNCTIONS
        function deleteMedia(id, type, element) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            const apiUrl = '/api/media/delete/';
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found');
                alert('Error: CSRF token not found. Please refresh the page.');
                return;
            }

            console.log(`Attempting to delete media_type: ${type} with media_id: ${id}`);

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ media_id: id, media_type: type }),
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                if (response.ok || response.status === 204) {
                    // Just remove the element from the DOM without refreshing
                    element.remove();
                    console.log(`Successfully deleted ${type} with ID: ${id}`);
                } else {
                    return response.text().then(text => {
                        console.error('Delete failed response text:', text);
                        try {
                            // Try parsing as JSON first for structured errors
                            const errorData = JSON.parse(text);
                            throw new Error(`Failed to delete ${type}. Status: ${response.status}. Server message: ${errorData.error || JSON.stringify(errorData)}`);
                        } catch (e) {
                             // If not JSON, use the raw text
                            throw new Error(`Failed to delete ${type}. Status: ${response.status}. Server message: ${text || 'No details'}`);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Delete request failed:', error);
                alert(`Failed to delete ${type}: ${error.message}`);
            });
        }

        function uploadImage(file) {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first.');
                return;
            }
            
            // Show progress container 
            const progressContainer = document.getElementById('image-upload-progress-container');
            const progressBar = document.getElementById('image-upload-progress-bar');
            const statusElement = document.getElementById('image-upload-status');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            statusElement.textContent = `Uploading ${file.name}...`;
            
            console.log(`Uploading image: ${file.name} for person ID: ${selectedPersonId}`);
            console.log(`File details - Size: ${file.size} bytes, Type: ${file.type}`);
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found');
                alert('Error: CSRF token not found. Please refresh the page.');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('title', file.name);
            
            // Create XMLHttpRequest to track upload progress
            const xhr = new XMLHttpRequest();
            
            // Set up progress event
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    statusElement.textContent = `Uploading ${file.name}... ${percentComplete}%`;
                }
            });
            
            // Set up load event (completed)
            xhr.addEventListener('load', function() {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        
                        if (data.success === false) {
                            throw new Error('Upload failed - server reported failure');
                        }
                        
                        statusElement.textContent = `Upload of ${file.name} complete!`;
                        
                        // Create and append the thumbnail
                        const imageUrl = data.image_url || data.url;
                        const imageId = data.image_id || data.id;
                        
                        if (imageUrl && imageId) {
                            const element = createThumbnailElement(imageUrl, imageId, 'image', data.title || file.name);
                            document.getElementById('images-grid').appendChild(element);
                        }
                        
                        // Hide progress after 2 seconds
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 2000);
                    } catch (error) {
                        console.error('Error parsing response:', error);
                        statusElement.textContent = `Error: Invalid response from server`;
                        progressBar.classList.add('bg-danger');
                    }
                } else {
                    statusElement.textContent = `Error: Server returned status ${xhr.status}`;
                    progressBar.classList.add('bg-danger');
                }
            });
            
            // Set up error event
            xhr.addEventListener('error', function() {
                statusElement.textContent = 'Error: Upload failed due to network error';
                progressBar.classList.add('bg-danger');
            });
            
            // Open and send the request
            xhr.open('POST', `/api/missing-persons/${selectedPersonId}/images/upload/`, true);
            xhr.setRequestHeader('X-CSRFToken', csrfToken);
            xhr.send(formData);
        }

        function uploadVideo(file) {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first.');
                return;
            }
            
            console.log(`Uploading video: ${file.name} for person ID: ${selectedPersonId}`);
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            if (!csrfToken) {
                console.error('CSRF token not found');
                alert('Error: CSRF token not found. Please refresh the page.');
                return;
            }
            
            const formData = new FormData();
            formData.append('video', file);
            formData.append('title', file.name);
            
            fetch(`/api/missing-persons/${selectedPersonId}/videos/upload/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Upload response status:', response.status);
                if (!response.ok) {
                    // If response is not OK, try to read the body for error details
                    return response.text().then(text => {
                         console.error('Upload failed response text:', text);
                         throw new Error(`Upload failed with status: ${response.status}. Server message: ${text || 'No details'}`);
                     });
                }
                // If response is OK, parse as JSON
                return response.json();
            })
            .then(data => {
                // This block only runs if response.ok was true
                console.log('Upload response data:', data);
                if (data.success) {
                    // Fix: Use the correct URL from the response and create a thumbnail element with it
                    const videoUrl = data.url || data.video_url; // Handle both possible response formats
                    console.log('Creating video thumbnail with URL:', videoUrl);
                    
                    const element = createThumbnailElement(videoUrl, data.video_id, 'video', data.title);
                    videosGrid.appendChild(element);
                    
                    // Force the video thumbnail to load immediately by creating a temporary video element
                    const tempVideo = document.createElement('video');
                    tempVideo.src = videoUrl;
                    tempVideo.style.display = 'none';
                    tempVideo.preload = 'metadata';
                    document.body.appendChild(tempVideo);
                    
                    // Remove temp video after it has loaded metadata
                    tempVideo.addEventListener('loadedmetadata', function() {
                        document.body.removeChild(tempVideo);
                    });
                    
                    // Handle case where metadata doesn't load
                    tempVideo.addEventListener('error', function() {
                        console.error('Error preloading video metadata:', this.error);
                        document.body.removeChild(tempVideo);
                    });
                } else {
                    // Handle cases where response is OK but API reports failure
                    throw new Error(data.error || 'API reported an unknown error');
                }
            })
            .catch(error => {
                console.error('Upload failed:', error);
                alert(`Failed to upload video: ${error.message}`);
            });
        }

        function showPreview(src, type) {
            console.log(`showPreview called - Type: ${type}, Attempting to load SRC: ${src}`); // Log entry and src
            previewContent.innerHTML = '';
            
            // Dispose of any previous player
            try {
                const player = videojs.getPlayer('live-preview-player');
                if (player) {
                    player.dispose();
                }
            } catch (e) {
                console.error('Error disposing video.js player:', e);
            }
            
            // Handle different media types
            if (type === 'image') {
                const img = document.createElement('img');
                img.alt = 'Preview Image';
                img.onerror = function() { // Add error handler
                    console.error(`Error loading image preview. SRC: ${this.src}`);
                    previewContent.innerHTML = '<p style="color:red;">Error loading image preview.</p>';
                };
                img.onload = function() { // Log success
                     console.log(`Image preview loaded successfully. SRC: ${this.src}`);
                };
                img.style.maxWidth = '100%';
                img.style.maxHeight = '80vh';
                img.src = src; // Set src last
                previewContent.appendChild(img);
                console.log(`Image element added to preview content with src: ${img.src}`);
            } 
            else if (type === 'video') {
                const video = document.createElement('video');
                video.src = src;
                video.controls = true;
                video.autoplay = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '80vh';
                previewContent.appendChild(video);
            } 
            else if (type === 'webcam-placeholder') {
                const message = document.createElement('p');
                message.textContent = 'Webcam is not active. Please start the webcam using the Web Cam button.';
                message.style.color = 'white';
                message.style.fontSize = '1.5rem';
                previewContent.appendChild(message);
            }
            else if (type === 'live') {
                const srcLower = src.toLowerCase();
                if (srcLower.includes('.m3u8') || srcLower.includes('.mpd')) {
                    const sourceType = srcLower.includes('.m3u8') ? 'application/x-mpegURL' : 'application/dash+xml';
                    
                    try {
                        const videoEl = document.createElement('video-js');
                        videoEl.id = 'live-preview-player';
                        videoEl.classList.add('vjs-default-skin');
                        videoEl.setAttribute('controls', '');
                        videoEl.setAttribute('preload', 'auto');
                        videoEl.style.width = '100%';
                        videoEl.style.maxWidth = '80vw';
                        videoEl.style.maxHeight = '80vh';
                        
                        const sourceEl = document.createElement('source');
                        sourceEl.src = src;
                        sourceEl.type = sourceType;
                        videoEl.appendChild(sourceEl);
                        
                        previewContent.appendChild(videoEl);
                        
                        videojs('live-preview-player');
                    } catch (e) {
                        console.error('Error initializing video.js:', e);
                        previewContent.innerHTML = '<p style="color:red;">Error loading stream player.</p>';
                    }
                } else {
                    const message = document.createElement('p');
                    message.textContent = 'Live preview only available for HLS (.m3u8) or DASH (.mpd) streams.';
                    message.style.color = 'white';
                    message.style.fontSize = '1.5rem';
                    previewContent.appendChild(message);
                }
            }
            
            previewOverlay.classList.add('active');
        }

        // REMOVED: Event listener for Start Search Button - using the onclick attribute in HTML instead

        // Helper function to redirect to the live search page
        function redirectToLiveSearch(personId, sourceId) {
            console.log(`Redirecting to live search with person ID: ${personId}, source ID: ${sourceId}`);
            window.location.href = `/search/live/person/${personId}/source/${sourceId}/`;
        }

        // Helper function to create a webcam source and navigate
        function createWebcamSourceAndNavigate(personId) {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/api/missing-persons/${personId}/webcam/add/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({}),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.source_id) {
                    // Navigate to the live search page with the new source ID
                    redirectToLiveSearch(personId, data.source_id);
                } else {
                    alert('Error creating webcam source. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error creating webcam source:', error);
                alert('Error creating webcam source. Please try again.');
            });
        }

        // Function to clean up webcam displays on page load
        function cleanupWebcamSources() {
            console.log('Cleaning up webcam sources');
            
            // Get all live thumbnails that are webcam placeholders but not active
            const inactiveWebcamPlaceholders = document.querySelectorAll('.media-thumbnail[data-source-type="webcam"]:not([data-active-webcam="true"])');
            
            // For each inactive webcam placeholder that has a duplicate
            const liveSourceIds = new Set();
            const duplicates = [];
            
            inactiveWebcamPlaceholders.forEach(element => {
                const id = element.id.split('-')[2];
                if (liveSourceIds.has(id)) {
                    duplicates.push(element);
                } else {
                    liveSourceIds.add(id);
                }
            });
            
            // Remove any duplicate webcam placeholders
            duplicates.forEach(element => {
                console.log('Removing duplicate webcam placeholder:', element.id);
                element.remove();
            });
        }
        
        // Call cleanup on page load
        cleanupWebcamSources();

        function takeSnapshot() {
            if (!selectedPersonId) {
                alert('Please select a missing person profile first.');
                return;
            }
            if (!currentWebcamStream || !isWebcamActive) {
                alert('Webcam is not active or stream not available.');
                return;
            }
        
            const videoPreview = document.getElementById('local-webcam-preview');
            if (!videoPreview) {
                console.error('Webcam preview element (local-webcam-preview) not found.');
                alert('Error: Could not find webcam preview.');
                return;
            }
        
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const context = canvas.getContext('2d');
            
            // The preview ('local-webcam-preview') is styled with `transform: scaleX(-1);`
            // This means the user sees a mirrored image. To make the snapshot match the preview,
            // we need to flip the canvas context horizontally before drawing the video frame.
            context.translate(canvas.width, 0);
            context.scale(-1, 1);
            context.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
        
            canvas.toBlob(function(blob) {
                const fileName = `snapshot-${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
                const imageFile = new File([blob], fileName, { type: 'image/png' });
                
                console.log('Snapshot taken, calling uploadImage:', imageFile.name);
                uploadImage(imageFile); // Use the existing uploadImage function
        
                // Optional: Give user feedback or close preview.
                // For now, the preview remains open and active.
                // alert('Snapshot captured and sent to uploads!');
            }, 'image/png');
        }
    });
</script>
{% endblock %} 